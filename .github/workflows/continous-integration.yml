name: Run molecule scenarios
on: [push, pull_request]
jobs:
  run-molecule:
    name: Test molecule scenarios
    strategy:
      fail-fast: false
      matrix:
        scenario: [backwards_compatibility, default, other_features, tls]
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repository
        uses: actions/checkout@v2

      - name: Install Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.6'

      - name: Install Pipenv
        run: python -m pip install pipenv

      - name: Cache Pipenv packages
        uses: actions/cache@v2
        with:
          path: ~/.local/share/virtualenvs
          key: ${{ hashFiles('**/Pipfile.lock') }}
      
      - name: Cache molecule ephemeral directory
        uses: actions/cache@v2
        with:
          path: ~/.cache/molecule/389ds-server/${{ matrix.scenario }}
          key: ${{ hashFiles('molecule/**') }}-${{ matrix.scenario }}
      
      - name: Delete state of previous run
        run: if [ -d ~/.cache/molecule/389ds-server/${{ matrix.scenario }} ]; then cd ~/.cache/molecule/389ds-server/${{ matrix.scenario }}; rm -rf ansible.cfg inventory molecule.yml state.yml; fi
      
      - name: Create docker images cache folder
        run: mkdir ~/docker-cache
      
      - name: Cache docker images
        uses: actions/cache@v2
        with:
          path: ~/docker-cache
          key: docker-cache-6
      
      - name: Import docker images backup
        run: if [ $(find ~/docker-cache/ -name "*.tar" | wc -l) -gt 0 ]; then for f in ~/docker-cache/*.tar; do docker image import $f $(basename $f | sed 's/.tar$//' | awk '{split($0,segments,"#");print "molecule_local/" segments[1] ":" segments[2]}'); done; fi

      - name: Install dependencies
        run: python -m pipenv install
      
      - name: Test
        run: docker image ls

      - name: Test molecule scenario
        run: python -m pipenv run molecule test -s ${{ matrix.scenario }}
      
      - name: Backup docker images
        run: for image in $(docker image ls -a | grep "molecule_local" | awk '{print $3;}' | grep -v "IMAGE"); do docker save $image -o ~/docker-cache/$(docker image ls | grep $image | awk '{print $1 "#" $2}' | sed 's#molecule_local/##').tar; done